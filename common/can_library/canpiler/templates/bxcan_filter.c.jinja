// bxCAN filter setup
static inline void bxcan_set_filters() {
    #ifdef CAN2
    CAN1->FMR  &= ~CAN_FMR_CAN2SB;
    CAN1->FMR  |= (14 << CAN_FMR_CAN2SB_Pos);
    #endif
    CAN1->FM1R |= 0x0FFFFFFF; // Set banks 0-27 to id mode
    CAN1->FS1R |= 0x0FFFFFFF; // Set banks 0-27 to 32-bit scale

    {% for p in peripherals if not p.startswith("FDCAN") %}
    {% set banks = mapping.filters.get(p, []) %}
    {% set accept_all = mapping.accept_all.get(p, False) %}
    
    {% if accept_all %}
    // Accept all messages for {{ p }}
    {% set bank_idx = 0 if p == "CAN1" else 14 %}
    CAN1->FM1R &= ~(1 << {{ bank_idx }}); // Mask mode
    CAN1->FS1R |= (1 << {{ bank_idx }});  // 32-bit scale
    CAN1->FA1R |= (1 << {{ bank_idx }});
    CAN1->sFilterRegister[{{ bank_idx }}].FR1 = 0;
    CAN1->sFilterRegister[{{ bank_idx }}].FR2 = 0;
    {% else %}
    {% for fb in banks %}
    // Bank {{ fb.bank_idx }}: {{ fb.msg1.name }}{% if fb.msg2 %}, {{ fb.msg2.name }}{% endif %} ({{ p }})
    CAN1->FA1R |= (1 << {{ fb.bank_idx }});
    {% set m1_macro = fb.msg1.macro_name ~ "_MSG_ID" %}
    {% if fb.is_ext1 %}
    CAN1->sFilterRegister[{{ fb.bank_idx }}].FR1 = (({{ m1_macro }}) << 3) | 4;
    {% else %}
    CAN1->sFilterRegister[{{ fb.bank_idx }}].FR1 = (({{ m1_macro }}) << 21);
    {% endif %}
    {% if fb.msg2 %}
    {% set m2_macro = fb.msg2.macro_name ~ "_MSG_ID" %}
    {% if fb.is_ext2 %}
    CAN1->sFilterRegister[{{ fb.bank_idx }}].FR2 = (({{ m2_macro }}) << 3) | 4;
    {% else %}
    CAN1->sFilterRegister[{{ fb.bank_idx }}].FR2 = (({{ m2_macro }}) << 21);
    {% endif %}
    {% else %}
    {% if fb.is_ext1 %}
    CAN1->sFilterRegister[{{ fb.bank_idx }}].FR2 = (({{ m1_macro }}) << 3) | 4;
    {% else %}
    CAN1->sFilterRegister[{{ fb.bank_idx }}].FR2 = (({{ m1_macro }}) << 21);
    {% endif %}
    {% endif %}
    {% endfor %}
    {% endif %}
    {% endfor %}
}
