{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "type": "object",
    "required": ["node_name", "scheduler", "busses", "fault_library_enabled"],
    "additionalProperties": false,
    "properties": {
        "node_name": { "type": "string" },
        "scheduler": { "enum": ["psched", "freertos"]},
        "busses": {
            "type": "object",
            "additionalProperties": {
                "$ref": "#/$defs/bus_messages"
            },
            "minProperties": 1
        },
        "fault_library_enabled": {
            "type": "boolean",
            "default": true,
            "description": "If false, the node will be excluded from the fault system (no sync, no ownership guards, no logic)."
        },
        "generate_fault_messages": {
            "type": "boolean",
            "description": "If true, the generator will produce the LCD message string arrays for this node. Useful for saving Flash on nodes without screens."
        },
        "faults": {
            "type": "array",
            "description": "Faults owned and evaluated by this node",
            "items": { "$ref": "#/$defs/fault_config" }
        }
    },
    "$defs": {
        "fault_config": {
            "type": "object",
            "required": ["fault_name", "max", "min", "priority", "time_to_latch", "time_to_unlatch", "lcd_message"],
            "additionalProperties": false,
            "properties": {
                "fault_name":  {
                    "type": "string",
                    "description": "name of the fault (Keep it short)"
                },
                "max": {
                    "type": "integer",
                    "description": "Max value of the fault (Max is exclusive)"
                },
                "min": {
                    "type": "integer",
                    "description": "Min value of the fault (Min is inclusive)"
                },
                "priority": {
                    "type": "string",
                    "enum": ["warning", "error", "fatal"],
                    "description": "Priority of fault, warning = no effect, error = readyToDrive, fatal = SDC"
                },
                "time_to_latch": {
                    "type": "integer",
                    "description": "Time fault must be set to officially enable the fault"
                },
                "time_to_unlatch": {
                    "type": "integer",
                    "description": "Time fault must be unset to offically disable a fault"
                },
                "lcd_message": {
                    "type": "string",
                    "description": "Message to display on LCD"
                }
            }
        },
        "bus_messages": {
            "type": "object",
            "required": ["peripheral"],
            "additionalProperties": false,
            "properties": {
                "peripheral": { "enum": ["CAN1", "CAN2", "FDCAN1", "FDCAN2", "FDCAN3"] },
                "accept_all_messages": { "type": "boolean" },
                "tx": {
                    "type": "array",
                    "items": { "$ref": "file:///message_schema.json#/$defs/tx_message" }
                },
                "rx": {
                    "type": "array",
                    "items": { "$ref": "file:///message_schema.json#/$defs/rx_message" }
                }
            }
        }
    }
}
