MACRO(MAKE_FLT_LIB lib_name lib_link hal_name)
    set(TARGET_NAME ${lib_name})
    add_library(${TARGET_NAME})

    # Find all .c sources in project
    file(GLOB_RECURSE glob_sources "*.c")

    # Include the unified fault data generated by the CAN library
    set(FAULT_GEN_C "${CMAKE_SOURCE_DIR}/common/can_library/generated/fault_data.c")
    
    target_sources(${TARGET_NAME} PRIVATE ${glob_sources} ${FAULT_GEN_C})

    # Find directories for '#include'
    # For libraries, these directories are all referenced to the top level firmware directory, CMAKE_SOURCE_DIR
    target_include_directories(${TARGET_NAME} PUBLIC 
        ${CMAKE_SOURCE_DIR}
        ${CMAKE_SOURCE_DIR}/common/can_library/generated
    )

    target_link_libraries(${TARGET_NAME} ${lib_link})
    target_link_libraries(${TARGET_NAME} ${hal_name})

    # Ensure CAN generation happens before we try to compile the fault data
    add_dependencies(${TARGET_NAME} can_generation)

ENDMACRO(MAKE_FLT_LIB)

MAKE_FLT_LIB(FAULTS_F407 CMSIS_F407 PHAL_F407)
MAKE_FLT_LIB(FAULTS_F732 CMSIS_F732 PHAL_F732)
