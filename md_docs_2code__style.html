<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PER Firmware: code_style</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">PER Firmware
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_docs_2code__style.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">code_style</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Irving Wang (<a href="#" onclick="location.href='mai'+'lto:'+'irv'+'in'+'gw@'+'pu'+'rdu'+'e.'+'edu'; return false;">irvin<span class="obfuscator">.nosp@m.</span>gw@p<span class="obfuscator">.nosp@m.</span>urdue<span class="obfuscator">.nosp@m.</span>.edu</a>)</p>
<h2><a class="anchor" id="autotoc_md69"></a>
About</h2>
<p>This document defines the general coding style and rules for PER-owned projects. Most of these rules are C-specific but the essence of the rules can still be applied to other languages.</p>
<p>The goal is to maintain a consistent and easily maintainable codebase. Following these rules reduces opportunities for hidden bugs and makes the code more readable and reviewable for others.</p>
<p>Additionally, the compiler standard for <code>firmware</code> is set to C23, enabling several important modern features.</p><ul>
<li><code>bool</code>, <code>nullptr</code> as standard keywords</li>
<li><code>constexpr</code> for compile-time constants</li>
<li><code>static_assert</code> for compile-time assertions</li>
</ul>
<h2><a class="anchor" id="autotoc_md70"></a>
Rules and Suggestions</h2>
<ol type="1">
<li><p class="startli">Avoid nesting where possible</p><ol type="a">
<li>Try using early returns and condition inversion<ul>
<li>remember to free resources (like semaphore/mutex) before returning</li>
</ul>
</li>
<li>No more than 4 indentations deep</li>
</ol>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> nesting_example_bad() {</div>
<div class="line">    <span class="keywordflow">if</span> (condition1) {</div>
<div class="line">        <span class="keywordflow">if</span> (condition2) {</div>
<div class="line">            <span class="comment">// code here</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> nesting_example_better() {</div>
<div class="line">    <span class="keywordflow">if</span> (!condition1) {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (!condition2) {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// code here</span></div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Use of dynamic memory allocation is forbidden<ol type="a">
<li>Absolutely no <code>malloc()</code>, this will open the risk for memory fragmentation</li>
<li>Instead, you must either allocate memory at compile time, or use stack-based local variables</li>
</ol>
</li>
<li>Avoid magic numbers<ol type="a">
<li>Define an <code>enum</code>, <code>static constexpr</code>, or macro</li>
<li>Prefer <code>static constexpr</code> over macros for inherent type safety</li>
</ol>
</li>
<li><p class="startli">Variable names</p><ol type="a">
<li>Use <code>snake_case</code></li>
<li>Try to use full words wherever possible</li>
<li>Keep it to a reasonable length</li>
<li>Global variables should be prefixed with <code>g_</code></li>
<li>Variables with units should have their unit at the end of the variable name</li>
<li>The exception to this rule is temporary variables in for loops like <code>i</code> or <code>j</code></li>
</ol>
<div class="fragment"><div class="line">g_global_var = 0;</div>
<div class="line">g_last_rx_time_ms = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="a__box_2main_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main</a>() {</div>
<div class="line">    local_var = 0;</div>
<div class="line">}</div>
<div class="ttc" id="aa__box_2main_8c_html_a840291bc02cba5474a4cb46a9b9566fe"><div class="ttname"><a href="a__box_2main_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main</a></div><div class="ttdeci">int main(void)</div><div class="ttdef"><b>Definition</b> <a href="a__box_2main_8c_source.html#l00083">main.c:83</a></div></div>
</div><!-- fragment --></li>
<li><p class="startli">Function names</p><ol type="a">
<li>Use <code>snake_case</code></li>
<li>Try to use full words wherever possible</li>
<li>Keep it to a reasonable length</li>
<li>Library functions should be prefixed with the library name in caps</li>
</ol>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> NXT_set_command();</div>
<div class="line"><span class="keywordtype">void</span> poll_shock_pots();</div>
</div><!-- fragment --></li>
<li>Macros<ol type="a">
<li>Use <code>SCREAMING_SNAKE_CASE</code></li>
<li>Same rules as function names</li>
<li><p class="startli">Wrap values with parenthesis to prevent expansion edge cases</p>
<p class="startli">```c // Example pulled from firmware/PR(#147)</p>
<p class="startli">// bad #define <a class="el" href="common__defs_8h.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS(x)</a> ((x) &lt; 0 ? (-1 * x) : x) // good #define <a class="el" href="common__defs_8h.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS(x)</a> ((x) &lt; 0 ? (-1 * (x)) : (x)) ```</p>
</li>
</ol>
</li>
<li>Inline functions<ol type="a">
<li>Use inline functions over macros wherever possible, they offer type safety</li>
</ol>
</li>
<li><p class="startli">Don’t use brace-less control statements</p>
<div class="fragment"><div class="line"><span class="comment">// bad</span></div>
<div class="line"><span class="keywordflow">if</span> (condition)</div>
<div class="line">    code();</div>
<div class="line">    </div>
<div class="line"><span class="comment">// good</span></div>
<div class="line"><span class="keywordflow">if</span> (condition) {</div>
<div class="line">    code();</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><p class="startli">Allowed data types</p><ol type="a">
<li><code>float</code></li>
<li><code>char</code></li>
<li><code>bool</code> (standard keyword in C23)</li>
<li>From <code>&lt;stdint.h&gt;</code></li>
</ol>
<div class="fragment"><div class="line"><span class="comment">// bad, size depends on architecture</span></div>
<div class="line"><span class="keywordtype">int</span> num;</div>
<div class="line"><span class="keywordtype">short</span> num2;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// good, explicit sizes</span></div>
<div class="line">int32_t num;</div>
<div class="line">int16_t num2;</div>
</div><!-- fragment --></li>
<li><p class="startli">Always initialize variables with a value</p><ol type="a">
<li>global variables should explicitly be zero’d out (even though the compiler does this for you)</li>
</ol>
<p class="startli"><code>c type_t g_global_struct = {0}; uint8_t g_global_val = 0; </code></p>
</li>
<li><p class="startli"><code>struct</code> declarations</p><ol type="a">
<li>Always use <code>typedef</code> and suffix your new type with <code>_t</code></li>
<li>Order your variables in descending size (this saves space from padding)</li>
<li>However exceptions can be made for logical/clarity purposes</li>
<li>Remember that we target 32-bit architecture for firmware<ul>
<li>pointers are 4 bytes</li>
</ul>
</li>
</ol>
<p class="startli">```c // bad, 24 bytes of padding typedef struct { uint16_t small_num; uint32_t medium_num; uint64_t big_num; uint16_t small_num2; } bad_struct_t</p>
<p class="startli">// good, 0 bytes of padding typedef struct { uint64_t big_num; uint32_t medium_num; uint16_t small_num; uint16_t small_num2; } good_struct_t; ```</p>
</li>
<li><p class="startli"><code>enum</code> declaration</p><ol type="a">
<li>Always use <code>typedef</code> and suffix your new type with <code>_t</code></li>
<li>Enum members should be prefixed with the name of the enum (example below)</li>
<li>Always explicitly declare the base type of the enum, ESPECIALLY when it is a member of a <code>struct</code></li>
<li>It is recommended to assign explicit values to each enum member</li>
</ol>
<p class="startli"><code>c // example enum typedef enum : uint8_t { FAULT_STATE_OK = 0, FAULT_STATE_PENDING = 1, FAULT_STATE_LATCHED = 2, FAULT_STATE_RECOVERING = 3 } fault_state_t; </code></p>
</li>
<li><p class="startli">Check null pointers before dereferencing</p>
<p class="startli">```c // bad void pass_by_reference(uint16_t *ptr) { *ptr = 10 }</p>
<p class="startli">// good void pass_by_reference(uint16_t *ptr) { if (ptr == nullptr) { return; // or return error code } *ptr = 10 } ```</p>
</li>
<li><p class="startli">Use apostrophes to format large numbers (C23) ```c // bad static constexpr uint32_t TargetCoreClockrateHz = 16000000;</p>
<p class="startli">// good static constexpr uint32_t TargetCoreClockrateHz = 16'000'000; ```</p>
</li>
<li>Run da formatter before merging your PR<ol type="a">
<li>Use the command <code>clang-format -i file.c</code> </li>
</ol>
</li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
